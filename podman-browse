#!/bin/bash
# podman-browse - Headless browser automation using Podman + Playwright
# Fetches JavaScript-rendered pages and returns text or HTML content

set -e

# Resolve symlink to get real script directory
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
IMAGE="mcr.microsoft.com/playwright:v1.50.0-noble"
PLAYWRIGHT_VERSION="1.50.0"

# Defaults
WAIT_MS=2000
OUTPUT_MODE="text"
SELECTOR=""

show_help() {
    cat << EOF
Usage: podman-browse [OPTIONS] URL

Fetch a JavaScript-rendered page using Playwright in Podman.

Options:
  --html              Return raw HTML instead of text
  --wait <ms>         Wait time after load (default: 2000ms)
  --selector <css>    Wait for specific element before capturing
  -h, --help          Show this help

Examples:
  podman-browse "https://example.com"
  podman-browse --html "https://example.com"
  podman-browse --selector ".content" --wait 5000 "https://example.com"
EOF
    exit 0
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --html)
            OUTPUT_MODE="html"
            shift
            ;;
        --wait)
            WAIT_MS="$2"
            shift 2
            ;;
        --selector)
            SELECTOR="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            URL="$1"
            shift
            ;;
    esac
done

if [[ -z "$URL" ]]; then
    echo "Error: URL is required" >&2
    echo "Usage: podman-browse [OPTIONS] URL" >&2
    exit 1
fi

# Run Playwright in Podman container with mounted script
podman run --rm -i \
    --ipc=host \
    --init \
    -v "$SCRIPT_DIR/browse.js:/app/browse.js:ro" \
    -e TARGET_URL="$URL" \
    -e WAIT_MS="$WAIT_MS" \
    -e OUTPUT_MODE="$OUTPUT_MODE" \
    -e SELECTOR="$SELECTOR" \
    "$IMAGE" \
    /bin/bash -c "cd /app && npm init -y >/dev/null 2>&1 && npm install playwright@$PLAYWRIGHT_VERSION >/dev/null 2>&1 && node browse.js"
